# Wizardbible #55

***

## 第0章：目次

***

- 第1章: Autopsyによるデジタルフォレンジック                     黒林檎 著

- 第2章: 錠前の鍵違い数について                                IPUSIRON 著

- 第3章: お知らせ

- 第4章: 著者プロフィール


***

## 第1章: Autopsyによるデジタルフォレンジック

著者：黒林檎

***


### 0x01 挨拶

　今回はデジタルフォレンジックついて書いてみたいと思います。
　このサイトを閲覧している皆様は業務でデジタルフォレンジック（以下DF）を
行っている方が多数いらっしゃっておると思いますので大変恐縮ですので読み飛
ばしていただいて結構です。

　今回は裁判に提出し証拠となるような高度なDFではありません。
　実際の業務で行うDFは証拠となりうる根拠から行います。Best evidence rule、
即ち最良証拠の原則にのっとって解析しなければなりません。
　それについてはここらへん読んでもらえたら結構です。

http://www2.tamacc.chuo-u.ac.jp/kikoh/sec_ikusei/sec2006/open2006text/08225-1.pdf

　次にデータのコピーです。
　DFにおいてオリジナルを解析することはまずありません。
　しかし最良証拠の原則により、オリジナルでなくても、オリジナルのコピーで
も原則的に同等の証拠として扱えます。

　そしてこのオリジナルコピーの方法ですが…。
　ビットストリームコピーと論理コピーという手法があります。
　ビットストリームコピーというのはオリジナルとまったく同じものを作成する
といったものです。

　この方法ではオリジナルを正確に1ビットずつすべて未使用領域すらも正確に
コピーします。対して、論理コピーはファイル実データのみをコピーする方法で
す。

　証拠として使えるDFの定義はもっと複雑です。
　後は必要時応じて追々説明していきます。

　後言い忘れましたが、今回のDFの対象はHDDとします。
　それではだらだらと法律（？）について語っているのも面白くないので、DFを
やっていきましょう。


### 0x02 ファイルの保存と削除

　最初にNTFSでのHDDへのファイルの保存と削除を勉強しましょう。

　デジタルフォレンジックという言葉を聞いて最初に連想するのはデータの復元
ではないでしょうか。

　ドラマや映画のハッカーでは、Enter一回でデータを復元してカッコよくきめて
しまうが、あれは嘘です。DFは「砂漠の中に落ちたダイヤを探すようなもの」と
例えることができます。

　今回はそのような難しいことはしないで、「風呂に落ちた指輪を探す」程度の
ようなことを行っていきます。

　それでは管理情報からの復元方法を見ていきます。
　NTFS（http://e-words.jp/w/NTFS.html）の場合ファイルシステムの管理情報が
2種類存在します。
　1つ目は$Bitmap、2つ目はMFTです。
　前者の方は$Bitmapはクラスターの利用状況を管理するテーブルであり、後者は
$MFTはパーティション内のすべてのファイルやフォルダ情報を管理するテーブル
です。

　ファイルシステムについては次のWebページを参考にしてください。

http://support.microsoft.com/kb/100108/ja

　必要項目は後で解説していきますので、HDDへのファイル保存と削除について解
説します。


### 0x03 ファイル保存

1.最初に。A.doc用のレコードとして確立します。
2.次に基本情報やファイル名などの書き込みます。
3.それが終われば、$Bitmapから利用可能なクラスターを確保します。
4.そして、クラスターが連続していない場合はオフセットの値を記録します。
5.最後に、データ領域の該当クラスタへデータを格納します。

### 0x04 ファイル削除

1.最初にレコードを解放します。このときファイル保存1のときに確立したエント
リビットマップに立てた1を0にします。
2.$Bitmapのビットデータを0にして、クラスターとのつながりを消します。
3.データ領域でのデータは消えずに、実際に消したはずのデータは$Bitmapとして
残っているわけです。ただし、ファイル保存時に書き込んだものは消えます。

　データを完全に消去するにはデータを書き込みます。要するに物理メモリを完
全に埋めることで完全削除できます。

　それでは消したはずのデータが実際は消えていないことを説明をしましたので、
次にいきたいと思います。

### 0x05 Autopsy

　やっぱりこういう企画にはAutopsyが定番ですよね。
　Windowsなら、FTK ImagerがありますがAutopsyの人気のが高いのかな？
　変態の国日本だからなのか、技術者的にはGO言語とかLinuxとか愛用してる方が
多い国だからなのか、LinuxのDFツールを使用してる方が周りに多いのでしょうか？

　まぁそれはさておき、実際Autopsyがこのような企画に王道化されてきたのは、
私的にはデジタルフォレンジックツールが高価であるのが理由の1つであると思い
ます。
　実際DFの値段がそれを示しています、高度な教育を受けた専門家が行うDFはか
なり高額なのに対して、民間？が行うDFは10万程度と財布にやさしい傾向にあり
ます。
　まぁそこらへん証拠保全とかいろいろ積もり積もった結果金額に反映している
と思われますが。

　それではAutopsyを起動させてください。
　BackTrackを使用している方はデフォルトで収録されております。

\# /usr/bin/autopsy 

　起動させたらブラウザからアクセスします。

　そうそうLinuxのddコマンドを利用しましょう。

　とりまイメージ化させます。

\# dd if=/dev/sdb of=/var/disk-img/some-windows-hdd.img

　ddコマンドの使い方はネット検索すれば多数出てきます。

　それでは解説に戻ります、いきなりですがAutopsyで最初に3つの選択肢があり
ますが、"NEW CASE"を選択してください。
　入力画面になりましたので案件やホストを登録します。
　入力項目の3つすべて同一でかまいません（処理結果に変わりはないという意味
です）。
　次はホストの登録ですがこれも今回は処理結果に変わりはないので飛ばします。

　それではやっと本命のディスクイメージを選択する画面になりました。
　イメージを選んでください。
　それではさっそくディスクイメージを選択してから、"ANALYZE"を選択します。
　"File Analize"を選ぶと、"File serch"を行う画面になります。
　目的のファイルまたは拡張子を検索すればファイル名に検索した名前がついて
いるファイル一覧が抽出されます。

　Autopsyはもちろんファイルをキーワード検索することもができます。"KEYWORD
 SERARCH"を選択してください。
　なにかしら拡張子を検索してください。検索結果を１つ選択すれば詳細にデー
タユニットをみることができ、MFTのリンクを選択すれば閲覧できエクスポートす
ることにより対象をファイルに保存することも可能です。

　次に、別のモードである"METADATA MODE"を解説します。
　メタデータを解析することはとても重要です。メタデータにはファイル作成者
や日時といったデータ管理において重要な情報が詰まっているからです。解析に
手詰まったらメタデータを調べるとよいでしょう。
　モード選択したら"ALLOCATION LIST"を開いてください。MFTの状態を確認でき
ます。
　復習ですがMFTは「パーティション内のすべてのファイルやフォルダ情報を管理
するテーブル」であす。
　削除されたファイルは赤字表示だ、ファイル名の後ろには.jpg/(deleted)と表
示されて、とてもわかりやすいです。
　もちろん先ほど同様エクスポートして、保存することができます。

　さてさて削除したファイルを表示させることはできました。これは大きい一歩
です。
　さらにAutopsyでは削除されたデータを復元することが可能です。
　しかしこれには一定のルールがありました。最初に述べたように、一般的に削
除したデータはデータ領域にまだ残っていて$Bitmapとのつながりを切っただけに
すぎず、完全削除は物理メモリを完全に埋めることで削除することができるのです。

\# dd if=/dev/zero of=/dev/hda

　上記のように、ddコマンドで簡単に実行できます。

　....と話がそれてしまいました。

　さてルールというほどでもありませんが、データ領域から削除されているデー
タは復元が難しいです。
　削除されていなければ簡単です。先ほど最初にやったFILE ANALYSISモードを開
いて、削除されているファイル（赤色表示されているファイル）をエクスポート
することで達成できるからです。

　どうだったでしょうか。ドラマでは適当にコマンドタイプして「復元完了（キ
リっ）」とか言っていますが、実際はGUIの画面をマウスでポチポチ操作するだけ
で実現できるのです。

　まぁAutopsy自体がSleuth KitってCUIベースのデジタルフォレンジックツール
をGUI化さした奴なんだけどね。

　後はディレクトリを復元するぐらいでしょうか。"FILE ANALYSIS"でエクスポー
トすることができます...。圧勝です。

　削除ディレクトリを選択しさらに削除されたデータファイルを探していきます。
　削除されたファイルを選択することで、元のディレクトリ情報を手に入れ同じ
ファイルのMFTを参照することができます。

### 0x06 感想

　今回はデジタルフォレンジックについてまとめました。
　そうそう皆さんはうインターネットフォレンジックという言葉は聞いたことが
あるでしょうか？
　クラッカーといえばCrackerを連想しKrackerという言葉が世間的に知られてい
ないように、フォレンジックといえばデジタルフォレンジックを連想しインター
ネットフォレンジックが知られていないのかもしれませんね。
　フォレンジックというのは犯罪捜査に科学的手法を取り入れたものをさすと聞
いたことがあります。
　デジタルフォレンジックはコンピューターがどのように犯行にかかわっている
か捜査します。逆にインターネットフォレンジックというのは個別のマシンから
インターネットへと、その中心が変化します。
　インターネットの中で違法行為またはその陰に隠れたものを探す行為がインタ
ーネットフォレンジックといいます。簡単にいうならばインターネットに残され
た証拠を探す作業です。

　最近ではそちらにも興味を持っています。
　より多くの実践的なハッキング技術を使いこなしてやるのが二十歳までの目標
です。



***

## 第2章: 錠前の鍵違い数について

著者：IPUSIRON

***


### 0x01 はじめに

　錠前のカタログを確認するとピッキングや破錠に対する耐性や値段だけでなく、
たびたび鍵違い数というものが記載されている。どうやら鍵違い数の値が大きい
方が安全性が高いような記述になっているが、そもそも鍵違い数とは何かという
ことが明記されていないことが多い。
　そこで本稿では鍵違い数の意味や各種錠前の鍵違い数の違いについて紹介する。

　まず鍵違い数の意味であるが、これは直観的にわかりやすい。鍵違い数とは鍵
のパターン数のことである。鍵のパターンは鍵山の形や鍵そのものの形によって
増減する。
　例えば、ある錠前の鍵違い数が1万であれば、その錠前を開錠するための鍵とし
て1万個のパターンが存在するということである。

　ところで、錠前の不正解錠を防ぐためのアプローチとしては、「不正解錠とい
う行為を困難にするアプローチ」と「不正解錠するために試行する回数を多くす
るというアプローチ」に大別できる。
　鍵違い数が大きいことは、後者のアプローチに関係する。つまり、鍵違い数が
大きければ、不正解錠という行為によって解錠に成功させるまでの時間を長くす
ることができるわけである。パスワード認証で例えれば、パスワード長が長いこ
とに相当する。
　なお、前者のアプローチは、キーウェイの形状やアンチピッキングピンの導入、
錠前の構造に対する工夫などによって実現される。

　それでは代表的な各種の錠前の鍵違い数の数え方について紹介する。


### 0x02 ウォード錠の鍵違い数

　ウォードとは鍵に対する障害物のことであり、この障害物をよけて通る鍵だけ
がウォード錠を開けることができる。

　ウォードの取り付け位置は、鍵を入れる孔や錠前の内部に設けられる。
　鍵を入れる孔のウォードは鍵違い数を増やすだけでなく、ピッキングの道具な
どを挿入することを拒んだり、ピッキング行為をやりにくくしたりするためにも
有効である。そのため、現在の錠前でもキーウェイ（鍵を入れる孔の溝）を複雑
にすることがある。

　ウォード錠かどうかを識別するには鍵の形を見るのが一番簡単である。
　まず棒鍵かどうかで識別する。棒鍵であればウォード錠かレバータンブラー錠
であることが多い。ただし、棒鍵ではないウォード錠の仕組みを採用した南京錠
も存在する。
　次に、鍵山に注目する。鍵山の凹部が棒に対して垂直に付いている鍵（ベッグ
  - ウォード型、ホイル・ウォード型、ニブ・ウォード型）や複雑な切り欠けが入
っている鍵（ブリッジ・ウォード型）である。

    -----------
    |         |
    ---|   |---
       |   |
    ---|   |---
```
              |
---------------

    -----------
    |         |
    ---|      |
    ---|      |
    |         |
    ---|      |
    ---|      |
```
              |
---------------

　ウォード錠の鍵違いは、基本的には次に示す事項から決定される。

①ウォードの位置

　鍵を入れる孔に設けられたウォードであれば数種類しか鍵違いがない。鍵違い
が数十〜百ぐらいであると、トライアウトキーによるブルートフォースアタック
に対して脆弱である（もっともウォード錠の場合はスケルトンキーにとても脆弱
である）。
　一方、錠前の内部に設けられたウォードであれば精巧に作られたものであれば
百数種類の鍵違いが得られる。


### 0x03 レバータンブラー錠の鍵違い数

　レバータンブラー錠は数枚の（レバー）タンブラーと呼ばれる板によりツク（
角棒）を固定することで施錠する錠前である。
　素朴な構造を持つレバータンブラー錠の場合はタンブラーにはH状の切り欠き（
ゲートと呼ぶ）が掘り込まれている。このH状の真ん中の「−」の部分がすべて揃
うことにより、ツクを左側の切り欠きの箇所から右側の切り欠きの箇所に移動す
ることができ、結果としてツクと一体化している閂が外れる。

　レバータンブラー錠かどうかを識別するには鍵の形を見るのが一番簡単である。
ウォード錠と異なり、凹部が棒と水平に付いている。

## ---
    | | | | | |
    | --- --- |
    |         |
```
              |
---------------

　レバータンブラー錠の鍵違いは、基本的には次に示す事項から決定される。

①タンブラーの種類
②タンブラーの枚数

　タンブラーの種類は、ゲートの位置の高さによって区分され、このゲートの位
置は鍵の刻みの深さに対応する。
　鍵穴がドアの向こう側に貫通しているようなタイプの場合は、外側・内側の両
方から鍵をかけることができる。ドアの中にタンブラーと錠箱（閂と連動してい
る錠内部の箇所）を格納するスペースの都合上、レバータンブラー錠は3〜4枚ほ
どしか入っていない。さらに、そのうち1枚は鍵違いには役立っていないことが多
い。
　鍵を見て鍵山（レバータンブラー錠ではレバーステップという）の数が5個ある
ように見えても、外側・内側の両方から鍵をかけることができる錠前であれば、
刻みは左右対称になっており、実質的に3個の鍵山だけが鍵違いに関係していることになる。

　タンブラーの種類をn、タンブラーの枚数をr、取り除くパターンをαとすると、
鍵違い数は次のようにして計算できる（金庫向けやマスターキーシステムは含まない）。

鍵違い数＝n^r-α

　例えば、一般のレバータンブラー錠の場合は、タンブラーの枚数は3〜4枚あり
、タンブラーの種類は5種類存在する。ただし、鍵違いに役立つタンブラーの枚数
はそのうちの2〜3枚になる。
　ここでは鍵違いに役立つタンブラーの枚数が2枚であると仮定すると、鍵違いの
パターンは5^2＝25通りになる。しかし、まったく刻みのないパターンはブランク
キーで開いてしまうので除く。さらに、最も深い刻みと刻みがないパターンが交
互になってしまうようなノコギリ状の場合は歯が折れる可能性を考慮して除かれ
ることが多い。つまり、全体のパターンから2パターンを取り除く。つまり、先ほ
どの例で言えば、鍵違い数は23通り（＝25-2）となる。
　仮に鍵違いに役立つタンブラーの枚数が3枚であると仮定しても、123通り（＝
5^3-2）程度である。

　これでは少なすぎるため、ウォード錠の原理を組み合わせて、2〜4倍に増やす
場合も多い。


### 0x04 ピンシリンダー錠の鍵違い数

　ピンタンブラー錠はレバータンブラー錠のように扉の両側から使用しないため、
鍵山を前後対称にすることを考える必要がないため、ピンの本数全部がすべて鍵
違いに役に立つ。

　ピンシリンダー錠の鍵違いは、基本的には次に示す事項から決定される。

①ピンの数
②ピンの長さの種類
③キーウェイの種類

　ピンの数が多ければ、鍵山の数もそれに応じて多くなる。

　また、ピンシリンダー錠の構造上、「下ピンの長さ＋鍵山の高さ＝内筒の直径」
になる。内筒の直径はピンシリンダー錠の種類が決定すれば固定であるため、鍵
山の高さが長い場合は下ピンが短く、鍵山の高さが短い場合は下ピンが長いとい
うことになる。
　鍵山の高さがすべて0のときはブランキーで開いてしまうため、このパターンは
通常は除く。

　さらに同一のタイプの内部構造を持つピンシリンダー錠であってもキーウェイ
の種類を複数持たせることによって、鍵違いを増やすことができる。
　このキーウェイの種類が多いと鍵違いを増やすことができるが、合い鍵屋にと
ってはその分用意しておくブランクキーの数が増えるという現状を生み出してい
る（鍵山の高さに関しては合鍵を作るマシンでコピーできるが、キーウェイはコ
ピーできないため）。

　ピンの長さの種類をn、ピンの数をr、キーウェイの種類をmとすると、鍵違い数
は次のようにして計算できる（マスターキーシステムは含まない）。

鍵違い数＝m(n^r-1)

　八万ロックはピンの配置が円状、ディンプル錠はピンの配置が多列になってい
るというだけであり、基本的に上記の公式が当てはまる。

　上下にドライバーピンを持つダブルピンタンブラー錠の場合は、構造的に外筒
が大きくなるが、ピンの数を倍程度に増やすことができるため、鍵違い数を増や
すためには有効である。
　また、八万ロックのピンは8〜10本、（玄関などに使われる）ディンプル錠のピ
ンは15〜20本程度と多くのピンを持たせることができるため、鍵違い数を増やし
やすい。最もこれらの錠前は単純に鍵違い数を増やすということよりも、不正に
解錠されることを防ぐための工夫を施し、結果的に鍵違い数が増えたともいえる
だろう。
　例えば、FBロックの場合は20本、KABA STARの場合は21本（後継機種の場合は26
本）、V18の場合は18本、SHOWA製のXキーシリンダーの場合は8本以上のピンを持
つ。Mul-T-Lockの場合ピンの中に細長いピンが入っている、即ち1箇所に2ピン存
在する。


### 0x05 ディスクシリンダー錠の鍵違い数

　玄関などに使用されるディスクシリンダー錠の鍵は通常上下の鍵山が有効に働
く。
　鍵山の高さの数が5段階であり、両面であることを考慮すると、鍵山の高さの数
は9段階(上下をプラス・マイナスで表現すると、-4,-3,-2,-1,-0,1,2,3
,4)といえる。

　鍵山の高さの数をn、ディスクの数をr、キーウェイの種類をmとすると、両面デ
ィスクタンブラー錠の鍵違い数は次のようにして計算できる。

鍵違い数＝m((2n-1)^r-1)

　例えば、MIWAの両面ディスクシリンダー錠の場合は、鍵山の高さの数は4段階、
ディスク（が格納される空間）の数は10枚、キーウェイは1種類である。よって、
上記の公式に当てはめれば、鍵違い数は282,475,249通り（＝(2×4-1)^10＝7^10）
である。
　ただし、販売されたままの状態の場合は、ディスクが格納される空間の2つは空
いた状態になっているため、実質的にはディスクの数は8枚である。よって、鍵違
い数は5,764,801通り（＝(2×4-1)^8＝7^8）である。

　もう1つ例を挙げる。例えば、MIWAのU9の場合は、鍵山の高さの数は5段階、ディ
スクの数は9枚、キーウェイは1種類である。よって、鍵違い数は387,420,489通り
（＝(2×5-1)^9）である。


### 0x06 EC錠の鍵違い数

　EC錠とは鍵内に磁石が埋め込まれているタイプの錠前である。EC錠に一言でい
っても色々あるため、ここでは日本で普及しているMIWAのEC錠について説明する。

　MIWAのEC錠の場合は、鍵の磁石の位置やN/Sの方向だけではなく、1列のディン
プルが用意されている。
　まず磁石についてだが、磁石の位置によって2つのタイプに分けられる（XEC/
RXEC）。また、磁石の方向としてはN極とS極の2パターンあり、磁石の取り付け
位置は6箇所ある。よって、磁石だけの観点からの鍵違い数は64通り（＝2×2^6）
である。
　ただし、6箇所すべてに磁石が使われるとは限らず、一部にダミーが使用され
ることもある。この場合は鍵違い数がその分減ることを意味する。
　次にディンプルについてだが、ディンプルの深さの種類には実質5段階あるの
だが、深さ0,1は使用されず、深さ2,3,4だけしか使用されない。またディンプル
の個数は4箇所である。よって、ディンプルだけの観点からの鍵違い数は81通り
（＝3^4）である。
　ゆえに、キーウェイは1種類であるため、鍵違い数は5,184通り（64×81）であ
る。

　ダミー数をα、ディスクの数をr、キーウェイの種類をmとすると、MIWAのEC錠
の鍵違い数は次のようにして計算できる。

鍵違い数＝(2×2^(6-α))×(3^4)＝81×2^(7-α)


### 0x07 まとめ

　最後に現在玄関に使われている錠前の鍵違い数について、表にまとめた。

|錠前の種類|タイプ|鍵違い数|リバーシブル|その他特徴|
|U9|ディスクシリンダー錠|約1億5100万通り|×|安価。ロッキングバーを採用。|
|U9 HM|ディスクシリンダー錠|150,994,944通り|×|ロッキングバーを採用。|
|KABA Star|ディンプル錠|約172億通り|○||
|PRシリンダー|ディスクシリンダー錠|約1000億通り|○|2WAY構造のタンブラー、アンチピッキングタンブラーを持つ。ロッキングバーを採用。|
|JNシリンダー|ディンプル錠|約172億通り|○||
|FBロック|ディンプル錠|最大1300億通り|○|鍵の先端にフローティングボールを持つ。|
|V18|ディンプル錠|約120億通り|○|アンチピッキングピンを持つ。|
|GVシリンダー|ディンプル錠|1000兆2800億通り|×|V18の上位モデル。|
|Mul-T-Lock|ディンプル錠|約3億6千万通り|○||
|WEST リプレイスシリンダー(916,917)|ディンプル錠|約2,935億通り|○|アンチピッキングピンを持つ。クリックボールがあるためキーの抜き差しがスムーズ。|
|ロイヤルガーディアン|ディンプル錠|約14億通り|○|バンピング、カム送り解錠を防ぐ。|


　本当は和錠や組み合わせ錠のような特殊な錠前の鍵違い数についても紹介した
かったが、まだ自分の中で整理できていなかった部分もあるので、今回は代表的
な錠前の鍵違い数についてのみ解説した。



***

## 第3章: お知らせ

***

- Wizard Bible（http://wizardbible.org/）では随時、執筆ライターを募集して
います。
　扱う内容のテーマは広義での「under ground」です。例えばハッキングやセキ
ュリティからピッキングなどと幅広い内容を考えています。また特殊な職業や趣
味の解説などでも構いません。
　一回きりでも構いません。また必ず毎回連載する義務もありませんので、でき
る範囲で構いません。気軽に声をかけてください。

- Kenji AikoさんがQ&Aを作ってくれました。初めて参加する人でもわかりやすく
書かれていますので、参考にしてください。

http://wizardbible.org/wbQandA.html

- Wizard Bibleに参加希望の方は気軽にメール（ipusiron@gmail.com）ください。


***

## 第4章: 著者プロフィール

***


### 黒林檎
●Job:自宅警備員
●Web: http://profile.ameba.jp/r00tapple/
●Twitter: aiceteaore
●Facebook: 黒林檎
●Mail: aiceteasun@gmail.com
●Comment:
　コーヒー屋に入ったらメニューで一番イメージが良い奴を注文しちゃう黒林檎
でーす!!
　今回はパソコン内の解析というありきたりな物になってしまいました。
　最近はインターネットフォレンジックの神秘性？に惹かれるお年頃です。
　ブログ全然書いてません、Twitterはやる気のないRTばっか、Facebookはちょく
ちょく更新してます!!


### IPUSIRON
●Job: 自宅警備員予備軍
●Web: http://akademeia.info
●Mail: ipusiron@gmail.com
●Comment:
　最近はピッキング関係の動画をYoutubeにアップロードしています。

http://www.youtube.com/profile?user=ipusiron&view=videos

　ネタはたくさんあるのですが、動画の作成には多大なる労力を用いるためにま
だ3本しか作成できていません。もっと効率よく作成できるような手法を確立化し
ていきたいと考えています。

